---
title: 日志
categories:
  - MySQL必知必会
toc: true 
---

- MySQL 日志包括通用查询日志、慢查询日志、错误日志、二进制日志、中继日志、重做日志和回滚日志
  - 通用查询日志
    记录了所有用户的连接开始时间和截止时间，以及发给 MySQL 数据库服务器的所有 SQL 指令，**还原操作时的具体场景**，帮助我们了解操作发生的具体时间和操作的细节
    - show variables like '%general%';
      ![image-20211014132742404](https://cdn.jsdelivr.net/gh/jiac3366/image-host@master/mysqlbizhbihui/image-20211014132742404.1c3b41tazw1s.png)
    - SET GLOBAL general_log = 'ON'; 
    - SET @@global.general_log_file = 'mytest.log';
  - 慢查询日志
    - show variables like 'min%';
    - long_query_time=10 和 min_examined_row_limit=0 共同判断：只要查询时间和扫描行数大于这2值就记录慢日志
  - 错误日志（排障首选）
    - 错误日志文件中记录了服务器启动的时间，以及存储引擎 InnoDB 启动和停止的时间等。
    - 默认是开启，可以在mysql配置文件“my.ini”中配置
  - 二进制日志
    记录数据库的更新事件
    - 查询和删除：
      - 正在写入的二进制日志
        - SHOW MASTER STATUS;
      - 所有的二进制日志
        - SHOW BINARY LOGS;
      - 二进制日志中所有数据更新事件:
        - SHOW BINLOG EVENTS IN 二进制文件名; ???
      - 重新开一个新的日志文件记录binlog
        - FLUSH BINARY LOGS;
      - 删除
        - RESET MASTER; 
        - 删除比指定二进制日志文件编号小的所有二进制日志文件
          - SQL：PURGE MASTER LOGS TO 'GJTECH-PC-bin.000005'; 
    - 利用mysqldump和binlog恢复数据
      - 1、数据库外执行：mysqldump -u root -p album > newbackup.sql
      - 2、flush binary logs
      - 3、发生宕机，检查确定要哪些binlog，因为超过系统变量 max_binlog_size 指定的值时，系统就会生成一个新的二进制日志文件)
      - 4、flush binary logs，与上一条刷新log对应组成的作用是，独立保留下全量备份到宕机时段的binlog文件，是防止后面数据恢复的事件被写入最新的二进制日志文件，妨碍理解文件的内容。
      - 5、重建DB，
      - 6、数据库外执行：mysql -u root -p django_album < newbackup.sql  **这时全量备份已恢复**
      - 7、show binlog events in 'binlog.000007';  查看找到最新的begin起始位置？这里假设是318
      - 8、数据库外执行：mysqlbinlog --start-position=318 "/var/lib/mysql/binlog.000007" | mysql -u root -p
        mysqlbinlog –start-positon=xxx –end-position=yyy 二进制文件名 | mysql -u 用户 -p
  - 中继日志
    - 

